<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Kalendář</title>
  <style>
    body { background: #0066b3; font-family: 'Open Sans', sans-serif; color: #FFFFFF; margin: 0; padding: 0;}
    h1 { text-align: center; color: #FFFFFF; margin-top: 24px;}
    .center { max-width: 1200px; margin: 0 auto; padding: 30px 20px;}
    .upload-block {text-align: center; margin-bottom: 30px;}
    .kalendar-wrap { background: #e6edfa; border-radius: 10px; padding: 20px 26px 24px 26px; margin-bottom: 28px;}
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;}
    .day-header { text-align: center; font-weight: bold; font-size: 18px; color: #0066b3; margin-bottom: 5px;}
    .cell { min-height: 120px; background: white; color: #444; border-radius: 10px; border: 2px solid #0066b3; padding: 6px 6px 3px 9px; position: relative; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-start; }
    .cell .day-num { font-size: 18px; font-weight: bold; color: #444; margin-bottom: 4px;}
    .names-list {margin: 3px 0 0 0; font-size: 13px;}
    .legend { margin: 32px 0 0 0; display: flex; gap: 35px; justify-content: flex-start;}
    .legend-item { display: flex; align-items: center; gap: 7px; font-size: 15px; color: #444;}
    .abs-dov { background: #42B63A; color: white; padding: 0 5px; border-radius: 2; }
    .abs-pul { background: #b3e8b2; color: #2A2A2A; padding: 0 5px; border-radius: 2;}
    .abs-nem { background: #DB4B3E; color: white; padding: 0 5px; border-radius: 2;}
    .abs-lek { background: #0066b3; color: white; padding: 0 5px; border-radius: 2;}
    .abs-ostatni { background: #9B59B6; color: white; padding: 0 5px; border-radius: 2;}
    .calendar-toolbar { display: flex; justify-content: flex-start; align-items: center; margin-bottom: 12px;}
    .month-select {font-size: 16px; border-radius: 5px; border:2px solid #DB4B3E; padding:4px 9px;}
    .pdf-btn, .print-btn { background:#0066b3; color:white; border:none; border-radius:4px; font-size:15px; padding:7px 14px; margin-left: 12px; cursor:pointer;}
    .print-btn {background: #4DA86E;}
    .pdf-btn:hover, .print-btn:hover { filter:brightness(1.13);}
    .print-title {font-size: 23px; font-weight: bold; color: #0066b3; margin-bottom: 14px; text-align:left;}
    @media (max-width:900px) {.calendar {font-size:12px; grid-template-columns: repeat(7, 1fr);}}
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible !important;}
      .print-area { position: absolute; left: 0; top: 0; width: 100vw; background: white;}
      .calendar-toolbar, .upload-block, h1 {display:none !important;}
      .print-title {display: block !important;}
    }
  </style>
</head>
<body>
  <h1>Kalendář</h1>
  <div class="center">
    <div class="upload-block">
      <span style="color:#d1ebff;">Nahraj CSV export z KS a udělej si přehled...</span><input type="file" id="csvInput" accept=".csv" />
    </div>
    <div class="kalendar-wrap" id="kalendarWrap" style="display:none;">
      <div class="calendar-toolbar">
        <select class="month-select" id="monthSelect"></select>
        <button class="pdf-btn" onclick="exportPDF()">Export PDF</button>
        <button class="print-btn" onclick="printKalendar()">Tisk kalendáře</button>
      </div>
      <div class="print-area" id="printArea">
        <div class="print-title" id="printTitle" style="display:block;"></div>
        <div id="calendarContainer"></div>
        <div class="legend" id="legendBlock">
          <div class="legend-item"><span class="abs-dov">DOV</span> Dovolená</div>
          <div class="legend-item"><span class="abs-pul">D/2</span> Dovolená 1/2</div>
          <div class="legend-item"><span class="abs-nem">NEM</span> Nemocenská</div>
          <div class="legend-item"><span class="abs-lek">LEK</span> Lékař</div>
          <div class="legend-item"><span class="abs-ostatni">OST</span> Ostatní absence</div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const absenceTypes = {
      'NEM':  { label: 'NEM',   cls: 'abs-nem', name: 'Nemocenská', order: 1 },
      'LEK':  { label: 'LEK',   cls: 'abs-lek', name: 'Lékař', order: 2 },
      'DOV':  { label: 'DOV',   cls: 'abs-dov', name: 'Dovolená', order: 3 },
      'D/2':  { label: 'D/2',   cls: 'abs-pul', name: 'Půlden dovolené', order: 4 }
    };
    function getAbsenceType(code) {
      code = (code || '').toUpperCase().replace(/\s+/g, '');
      if (code === 'NEM') return absenceTypes['NEM'];
      if (code === 'LEK') return absenceTypes['LEK'];
      if (code === 'DOV') return absenceTypes['DOV'];
      if (code === 'D/2' || code === '1/2DOV' || code === 'PULDOV') return absenceTypes['D/2'];
      if (code && code !== 'SME' && code !== '-') return { label: code, cls: 'abs-ostatni', name: 'Ostatní', order: 5 };
      return null;
    }
    const mesice = ["LEDEN","ÚNOR","BŘEZEN","DUBEN","KVĚTEN","ČERVEN","ČERVENEC","SRPEN","ZÁŘÍ","ŘÍJEN","LISTOPAD","PROSINEC"];

    function saveToCache(parsed, year, month) {
      let cache = {parsed, year, month};
      localStorage.setItem("kalendarCache", JSON.stringify(cache));
    }
    window.addEventListener('DOMContentLoaded', () => {
      let cache = localStorage.getItem("kalendarCache");
      if (cache) {
        let data = JSON.parse(cache);
        renderKalendar(data.parsed, data.year, data.month);
      }
    });

    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        let parsed = parseCSV(text);
        let today = new Date();
        let m = today.getMonth()+1, y = today.getFullYear();
        renderKalendar(parsed, y, m);
        saveToCache(parsed, y, m);
      };
      reader.readAsText(file, 'windows-1250');
    });

    function fillMonthSelect(year, month) {
      let ms = document.getElementById('monthSelect');
      ms.innerHTML = '';
      let now = new Date();
      for(let y = now.getFullYear()-1; y <= now.getFullYear()+1; y++) {
        for(let m = 1; m <= 12; m++) {
          let opt = document.createElement('option');
          opt.value = `${y}-${m}`;
          opt.innerText = `${mesice[m-1]} ${y.toString().slice(-2)}`;
          if(y == year && m == month) opt.selected = true;
          ms.appendChild(opt);
        }
      }
      ms.onchange = function() {
        let [yy, mm] = ms.value.split('-');
        let cache = localStorage.getItem("kalendarCache");
        if (cache) {
          let data = JSON.parse(cache);
          renderKalendar(data.parsed, parseInt(yy), parseInt(mm));
          saveToCache(data.parsed, parseInt(yy), parseInt(mm));
        }
      }
    }

    function renderKalendar(parsed, year, month) {
      document.getElementById('kalendarWrap').style.display = "";
      fillMonthSelect(year, month);
      let title = `${mesice[month-1]} ${year.toString().slice(-2)}`;
      document.getElementById('printTitle').innerText = title;
      let calendarArea = document.getElementById('calendarContainer');
      calendarArea.innerHTML = "";
      const dnyTydne = ['Po','Út','St','Čt','Pá','So','Ne'];
      let days = new Date(year, month, 0).getDate();
      let data = {};
      for(let i=1; i<=days; i++) data[i] = [];
      if (parsed && parsed.data) {
        for(let i=1;i<=days;i++) {
          if(parsed.data[i]) data[i] = parsed.data[i];
        }
      }
      function sortAbs(a, b) {
        const oA = a.typ.order || 99;
        const oB = b.typ.order || 99;
        if (oA !== oB) return oA - oB;
        return a.jmeno.localeCompare(b.jmeno, 'cs');
      }
      let weekStart = (new Date(year, month-1, 1).getDay() + 6) % 7;
      let calendarHtml = `<div class="calendar">`;
      dnyTydne.forEach(d=>{calendarHtml+=`<div class="day-header">${d}</div>`;});
      let cell = 0;
      for(let i=0;i<weekStart;i++){ calendarHtml += `<div class="cell"></div>`; cell++;}
      for(let den=1; den<=days; den++) {
        calendarHtml += `<div class="cell"><div class="day-num">${den}</div>`;
        if(data[den] && data[den].length) {
          calendarHtml += `<div class="names-list">`;
          data[den].sort(sortAbs).forEach(abs => {
            calendarHtml += `<div class="${abs.typ.cls}">${(abs.jmeno || "").replace(/ *[|\/-].*$/,"").trim()}</div>`;
          });
          calendarHtml += `</div>`;
        }
        calendarHtml += `</div>`;
        cell++;
      }
      while(cell%7!==0){calendarHtml+=`<div class="cell"></div>`; cell++;}
      calendarHtml += `</div>`;
      calendarArea.innerHTML = calendarHtml;
    }

    function printKalendar() {
      window.print();
    }

    function exportPDF() {
      import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js').then(html2canvas => {
        html2canvas = html2canvas.default;
        let area = document.getElementById('printArea');
        let calTitle = document.getElementById('printTitle').innerText;
        html2canvas(area, {backgroundColor: "#fff"}).then(canvas => {
          let imgData = canvas.toDataURL('image/png');
          const pdf = new window.jspdf.jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
          let width = pdf.internal.pageSize.getWidth();
          let imgWidth = width - 80;
          let imgHeight = canvas.height * (imgWidth / canvas.width);
          pdf.addImage(imgData, 'PNG', 40, 34, imgWidth, imgHeight);
          pdf.save('kalendar-' + calTitle.replace(" ","_") + '.pdf');
        });
      });
    }

    function parseCSV(csv) {
      let delimiter = ';';
      if (csv.split(';').length < csv.split(',').length) delimiter = ',';
      let lines = csv.split(/\r?\n/).filter(r => r.trim() !== '');
      let headerIdx = lines.findIndex(r => r.split(delimiter).some(cell => cell.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes('zamestnanec')));
      if (headerIdx < 0) { alert('Chyba: nenašel jsem sloupec \"Zaměstnanec\".'); return {}; }
      let header = lines[headerIdx].split(delimiter);
      let jmenoIdx = header.findIndex(h => h.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes('zamestnanec'));
      let denSloupce = [];
      header.forEach((h, i) => { if (/^\d+$/.test(h.trim())) denSloupce.push(i); });
      let zamRows = lines.slice(headerIdx+1);
      let data = {};
      denSloupce.forEach((_, i) => { data[i+1] = []; });
      zamRows.forEach(row => {
        const cols = row.split(delimiter);
        const jmeno = (cols[jmenoIdx] || '').trim();
        if (!jmeno) return;
        denSloupce.forEach((colIdx, i) => {
          let typ = (cols[colIdx] || '').trim().toUpperCase();
          if (!typ || typ === 'SME' || typ === '-') return;
          let absType = getAbsenceType(typ);
          if (absType) data[i+1].push({ jmeno, typ: absType });
        });
      });
      return {data};
    }
  </script>
</body>
</html>
