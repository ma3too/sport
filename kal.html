<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Měsíční kalendář absencí z CSV</title>
  <style>
    body { background: #F5F6FA; font-family: 'Open Sans', sans-serif; color: #2A2A2A; margin: 0; padding: 0;}
    h1 { text-align: center; color: #2A64AD; margin-top: 24px;}
    .center { max-width: 1200px; margin: 0 auto; padding: 30px 20px;}
    .upload-block {text-align: center; margin-bottom: 30px;}
    .calendar { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 8px; 
      background: #e6edfa; 
      border-radius: 16px; 
      padding: 20px;
    }
    .day-header { text-align: center; font-weight: bold; font-size: 18px; color: #2A64AD; margin-bottom: 5px;}
    .cell { 
      min-height: 120px; 
      max-height: 120px; 
      height: 120px;
      background: white; 
      border-radius: 10px; 
      box-shadow: 0 0 6px #c3cbe1; 
      padding: 6px 6px 3px 9px; 
      position: relative; 
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .cell .day-num { font-size: 18px; font-weight: bold; color: #444; margin-bottom: 4px;}
    .legend { margin: 32px 0 0 0; display: flex; gap: 35px; justify-content: center;}
    .legend-item { display: flex; align-items: center; gap: 7px; font-size: 15px;}
    .abs-dov { background: #DB4B3E; color: white; padding: 0 5px; border-radius: 6px; }
    .abs-pul { background: #E8B000; color: #2A2A2A; padding: 0 5px; border-radius: 6px;}
    .abs-nem { background: #2A64AD; color: white; padding: 0 5px; border-radius: 6px;}
    .abs-lek { background: #4DA86E; color: white; padding: 0 5px; border-radius: 6px;}
    .abs-ostatni { background: #9B59B6; color: white; padding: 0 5px; border-radius: 6px;}
    .names-list {margin: 3px 0 0 0; font-size: 13px;}
    @media (max-width:900px) {.calendar {font-size:12px; grid-template-columns: repeat(7, 1fr);}}
  </style>
</head>
<body>
  <h1>Měsíční kalendář absencí (CSV → kalendář)</h1>
  <div class="center">
    <div class="upload-block">
      <input type="file" id="csvInput" accept=".csv" />
      <br><br>
      <span style="color:#888;">Nahraj svůj exportovaný CSV soubor...</span>
    </div>
    <div id="calendarContainer"></div>
    <div class="legend">
      <div class="legend-item"><span class="abs-dov">DOV</span> Dovolená</div>
      <div class="legend-item"><span class="abs-pul">1/2 DOV</span> 1/2 dovolené</div>
      <div class="legend-item"><span class="abs-nem">NEM</span> Nemocenská</div>
      <div class="legend-item"><span class="abs-lek">LEK</span> Lékař</div>
      <div class="legend-item"><span class="abs-ostatni">OST</span> Ostatní absence</div>
    </div>
  </div>
  <script>
    const absenceTypes = {
      'DOV':  { label: 'DOV',   cls: 'abs-dov', name: 'Dovolená' },
      '1/2 DOV': { label: '1/2 DOV', cls: 'abs-pul', name: 'Půlden dovolené' },
      'NEM':  { label: 'NEM',   cls: 'abs-nem', name: 'Nemocenská' },
      'LEK':  { label: 'LEK',   cls: 'abs-lek', name: 'Lékař' }
    };
    function getAbsenceType(code) {
      code = (code || '').toUpperCase().replace(/\s+/g, '');
      if (code === 'DOV') return absenceTypes['DOV'];
      if (code === '1/2DOV' || code === '1/2 DOV' || code === 'PULDOV') return absenceTypes['1/2 DOV'];
      if (code === 'NEM') return absenceTypes['NEM'];
      if (code === 'LEK') return absenceTypes['LEK'];
      if (code && code !== 'SME' && code !== '-') return { label: code, cls: 'abs-ostatni', name: 'Ostatní' };
      return null;
    }
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        renderCalendar(text);
      };
      reader.readAsText(file, 'windows-1250');
    });
    function renderCalendar(csv) {
      let delimiter = ';';
      if (csv.split(';').length < csv.split(',').length) delimiter = ',';
      let lines = csv.split(/\r?\n/).filter(r => r.trim() !== '');
      // === Najdeme řádek s hlavní hlavičkou ("Zaměstnanec", "1", "2", ...)
      let headerIdx = lines.findIndex(r => r.split(delimiter).some(cell => cell.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes('zamestnanec')));
      if (headerIdx < 0) { alert('Chyba: nenašel jsem sloupec \"Zaměstnanec\".'); return; }
      let header = lines[headerIdx].split(delimiter);
      let jmenoIdx = header.findIndex(h => h.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes('zamestnanec'));
      if (jmenoIdx === -1) { alert('Chyba: nenašel jsem sloupec se jmény.'); return; }
      // Najdi všechny indexy sloupců s číslem dne
      let denSloupce = [];
      header.forEach((h, i) => { if (/^\d+$/.test(h.trim())) denSloupce.push(i); });
      // Data až od dalšího řádku pod skutečnou hlavičkou
      let zamRows = lines.slice(headerIdx+1);
      let data = {};
      denSloupce.forEach((_, i) => { data[i+1] = []; });
      zamRows.forEach(row => {
        const cols = row.split(delimiter);
        const jmeno = (cols[jmenoIdx] || '').trim();
        if (!jmeno) return;
        denSloupce.forEach((colIdx, i) => {
          let typ = (cols[colIdx] || '').trim().toUpperCase();
          if (!typ || typ === 'SME' || typ === '-') return;
          let absType = getAbsenceType(typ);
          if (absType) data[i+1].push({ jmeno, typ: absType });
        });
      });
      let dnyVMesici = denSloupce.length;
      let now = new Date();
      let month = now.getMonth()+1, year = now.getFullYear();
      let weekStart = (new Date(year, month-1, 1).getDay() + 6) % 7;
      let calendarHtml = `<div class="calendar">`;
      ['Po','Út','St','Čt','Pá','So','Ne'].forEach(d=>{calendarHtml+=`<div class="day-header">${d}</div>`;});
      let cell = 0;
      for(let i=0;i<weekStart;i++){ calendarHtml += `<div class="cell"></div>`; cell++;}
      for(let den=1; den<=dnyVMesici; den++) {
        calendarHtml += `<div class="cell"><div class="day-num">${den}</div>`;
        if(data[den].length) {
          calendarHtml += `<div class="names-list">`;
          data[den].forEach(abs => {
            calendarHtml += `<div class="${abs.typ.cls}">${abs.jmeno} <span style="font-size:11px;">${abs.typ.label}</span></div>`;
          });
          calendarHtml += `</div>`;
        }
        calendarHtml += `</div>`;
        cell++;
      }
      while(cell%7!==0){calendarHtml+=`<div class="cell"></div>`; cell++;}
      calendarHtml += `</div>`;
      document.getElementById('calendarContainer').innerHTML = calendarHtml;
    }
  </script>
</body>
</html>
